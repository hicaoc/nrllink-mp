<view class="container">
  <!-- Header Section -->
  <view class="header-section">
    <!-- First Row: User Identity and Server Status -->
    <view class="header-content">
      <!-- Left: User Identity -->
      <view class="user-info-box">
        <button class="avatar-wrapper" open-type="chooseAvatar" bind:chooseavatar="onChooseAvatar">
          <image class="avatar" src="{{userInfo.avatar}}" mode="aspectFill"></image>
        </button>
        <view class="user-text">
          <view class="user-row-one">
            <text class="user-name">{{userInfo.name || 'USER'}}</text>
            <text class="user-callsign">{{userInfo.callsign}}-100</text>
          </view>
          <view class="user-tags">
            <view class="tag">DMR:{{userInfo.dmrid}}</view>
            <view class="tag">MDC:{{userInfo.mdcid}}</view>
          </view>
        </view>
      </view>
      <!-- Right: Connection Status -->
      <view class="system-status-box">
        <view class="server-label clickable" bindtap="handleServerClick">
          <view class="status-indicator-dot {{serverConnected ? 'online' : 'offline'}}"></view>
          <view class="server-info-text">
            <text class="server-name">{{serverConfig.name}}</text>
            <text class="server-addr">{{serverConfig.host}}</text>
          </view>
        </view>
      </view>
    </view>
    <!-- Second Row: Group Information -->
    <view class="group-row">
      <!-- Left: Group Name (Clickable to switch) -->
      <picker bindchange="onGroupPickerChange" range="{{availableGroupsForPicker}}" range-key="displayGroupName" class="group-picker">
        <view class="group-name-section clickable">
          <text class="group-name-text">{{currentGroup || 'STANDBY'}}</text>
          <text class="group-switch-hint">â–¾</text>
        </view>
      </picker>
      <!-- Right: Online/Total Count (Clickable to show details) -->
      <view class="group-count-section clickable" bindtap="showOnlineDevices">
        <text class="count-online">{{onlineCount}}</text>
        <text class="count-separator">/</text>
        <text class="count-total">{{deviceCount}}</text>
      </view>
    </view>
  </view>
  <!-- Chat History Section -->
  <scroll-view class="chat-section" scroll-y enable-flex scroll-into-view="{{scrollIntoView}}" scroll-with-animation>
    <view class="chat-list">
      <block wx:for="{{chatLogs}}" wx:key="id">
        <view id="msg-{{item.id}}" class="message-item {{item.isSelf ? 'self' : 'other'}}">
          <view class="avatar-sm" wx:if="{{!item.isSelf}}">{{item.callsign[0]}}</view>
          <view class="bubble-container">
            <view class="sender-info" wx:if="{{!item.isSelf}}">
              <view class="sender-main">
                <text class="sender-name">{{item.callsign}}-{{item.ssid}}</text>
                <text wx:if="{{item.dmrid}}" class="sender-dmrid">({{item.dmrid}})</text>
                <text class="sender-time">{{item.timestamp}}</text>
              </view>
              <text class="sender-qth" wx:if="{{item.qth}}">{{item.qth}}</text>
            </view>
            <!-- Voice Bubble -->
            <view wx:if="{{item.type === 'voice'}}" class="bubble voice-bubble {{currentPlayingId === item.id && isVoicePlaying ? 'playing' : ''}}" bindtap="playVoice" data-filepath="{{item.filePath}}" data-id="{{item.id}}" style="width: {{20 + item.duration * 5}}%; max-width: 66%;">
              <view class="voice-icon {{currentPlayingId === item.id && isVoicePlaying ? 'playing' : ''}}">
                <view class="play-icon-inner"></view>
              </view>
              <text class="duration">{{item.duration}}s</text>
            </view>
            <!-- Text Bubble -->
            <!-- Text/Media Bubble -->
            <view wx:else class="bubble text-bubble {{item.subType}}">
              <!-- Image -->
              <block wx:if="{{item.subType === 'img'}}">
                <image src="{{item.content}}" mode="widthFix" class="chat-image" bindtap="previewImage" data-src="{{item.content}}" show-menu-by-longpress></image>
              </block>
              <!-- Location -->
              <block wx:elif="{{item.subType === 'loc'}}">
                <view class="location-content" bindtap="openLocation" data-loc="{{item.content}}">
                  <text class="location-icon">ğŸ“</text>
                  <text>{{item.content}}</text>
                </view>
              </block>
              <!-- Video -->
              <block wx:elif="{{item.subType === 'video'}}">
                <text class="media-link">ğŸ¬ [è§†é¢‘æ¶ˆæ¯] {{item.content}}</text>
              </block>
              <!-- Audio -->
              <block wx:elif="{{item.subType === 'audio'}}">
                <text class="media-link">ğŸµ [éŸ³é¢‘æ¶ˆæ¯] {{item.content}}</text>
              </block>
              <!-- Default / Text -->
              <block wx:else>
                <text selectable>{{item.content}}</text>
              </block>
            </view>
          </view>
        </view>
      </block>
      <!-- Active Receiving Bubble -->
      <view class="message-item other active-receiving" wx:if="{{isReceivingVoice}}">
        <view class="avatar-sm">{{CallSign[0]}}</view>
        <view class="bubble-container">
          <view class="sender-info">
            <text class="sender-name">{{CallSign}}-{{SSID}}</text>
            <text class="status-receiving">æ­£åœ¨æ¥æ”¶...</text>
          </view>
          <view class="bubble voice-bubble receiving" style="width: {{receivingBubbleWidth}}%;">
            <view class="voice-icon playing">
              <view class="play-icon-inner"></view>
            </view>
            <text class="duration">{{duration}}s</text>
          </view>
        </view>
      </view>
    </view>
  </scroll-view>
  <!-- Online Devices Modal -->
  <view class="modal-overlay {{showOnlineModal ? 'show' : ''}}" bindtap="hideOnlineDevices">
    <view class="modal-container" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">åœ¨çº¿è®¾å¤‡åˆ—è¡¨</text>
        <view class="modal-close" bindtap="hideOnlineDevices">âœ•</view>
      </view>
      <view class="modal-body">
        <view wx:if="{{onlineDevicesList.length === 0}}" class="empty-state">
          <text>æš‚æ— åœ¨çº¿è®¾å¤‡</text>
        </view>
        <view wx:else class="device-list">
          <view wx:for="{{onlineDevicesList}}" wx:key="id" class="device-item">
            <view class="device-avatar">{{item.callsign[0]}}</view>
            <view class="device-info">
              <text class="device-callsign">{{item.callsign}}-{{item.ssid}}</text>
              <text class="device-status">åœ¨çº¿</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
  <!-- Server Switch Modal -->
  <view class="modal-overlay {{showServerModal ? 'show' : ''}}" bindtap="hideServerModal" wx:if="{{showServerModal}}">
    <view class="modal-container server-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">åˆ‡æ¢æœåŠ¡å™¨</text>
        <view class="modal-close" bindtap="hideServerModal">âœ•</view>
      </view>
      <view class="modal-body">
        <!-- Server Picker -->
        <view class="form-item">
          <text class="form-label">é€‰æ‹©æœåŠ¡å™¨</text>
          <picker bindchange="onServerPickerChange" value="{{tempServerIndex}}" range="{{serverList}}" range-key="name">
            <view class="picker-view">{{serverList[tempServerIndex].name || 'è¯·é€‰æ‹©æœåŠ¡å™¨'}}</view>
          </picker>
        </view>
        <!-- Username Input -->
        <view class="form-item">
          <text class="form-label">ç”¨æˆ·å</text>
          <input class="form-input" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" bindinput="onServerUsernameInput" value="{{tempUsername}}" />
        </view>
        <!-- Password Input -->
        <view class="form-item">
          <text class="form-label">å¯†ç </text>
          <input class="form-input" type="password" placeholder="è¯·è¾“å…¥å¯†ç " bindinput="onServerPasswordInput" value="{{tempPassword}}" />
        </view>
        <!-- Switch Button -->
        <button class="switch-server-btn" bindtap="confirmServerSwitch">åˆ‡æ¢æœåŠ¡å™¨</button>
      </view>
    </view>
  </view>
  <!-- Bottom Input & PTT Section -->
  <view class="bottom-area">
    <view class="input-bar">
      <input class="text-input" value="{{inputText}}" bindinput="onInput" placeholder="è¾“å…¥æ¶ˆæ¯..." confirm-type="send" bindconfirm="sendMessage" />
      <view class="send-btn {{inputText.length > 0 ? 'active' : ''}}" bindtap="sendMessage">
        <text class="iconfont icon-send">å‘é€</text>
      </view>
    </view>
    <view class="ptt-bar">
      <view class="status-indicator {{serverConnected ? 'connected' : 'disconnected'}}"></view>
      <button class="ptt-btn {{isTalking ? 'active' : ''}}" bindtap="toggleTalk">
        <view class="ptt-icon"></view>
        <text>{{isTalking ? 'æ­£åœ¨å‘å°„ TX...' : 'ç‚¹å‡»å‘è¨€'}}</text>
      </button>
    </view>
  </view>
</view>